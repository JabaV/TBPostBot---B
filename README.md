# TBPostBot — Автоматический постинг в VK

TBPostBot — скрипт для автоматизированного постинга в сообщества VK. Тексты собираются из блоков (TextBuilder) по конфигу `files/groups.txt` (новый формат) либо из отдельных файлов (старый формат). Скрипт учитывает тип стены сообщества и режим предложки, ведёт логирование и поддерживает задержки между публикациями.

## Архитектура

Компоненты:
- `botautomatic.py` — главный цикл, интеграция с VK API, логика выбора времени/решений о постинге, парсеры, TextBuilder, публикация.
- `modules/module_logger.py` — простое логирование в файлы `log.txt` и `error_log.txt`.
- `files/` — данные:
  - `groups.txt` — конфиг целей для постинга (новый/старый форматы; поддерживаются комментарии).
  - `tags.txt`, `block1.txt` … `block5.txt`, `links.txt` — варианты блоков для TextBuilder (формат с маркерами `##`/`###`).
  - `text1.txt` … `text5.txt` — пример старых текстов.
  - `dumping.pkl` — кэш времени последней публикации по группам.
- `.env` — конфигурация окружения (токен VK и дефолтная задержка).

Потоки данных:
1) Чтение `files/groups.txt` построчно, пропуск комментариев.
2) Парсинг строки: новый формат — сборка текста из блоков; старый — чтение текста из файла.
3) Определение интервала (новый delay или старый `?seconds` или дефолт).
4) Получение типа стены и принятие решения о публикации:
   - Стены 2/3 (есть предложка): анализ пустоты/давности предложки, либо смотрим свой последний пост.
   - Стена 1: анализ давности своего последнего поста.
5) Публикация, обновление кэша времени.

## Требования и окружение

- Python 3.9+
- Зависимости: см. `requirements.txt`.

Переменные окружения (.env):
- TOKEN (str, required) — VK API токен (не коммитьте .env).
- DEFAULT_WAIT_TIME (int, seconds, optional) — дефолтная задержка между попытками постинга; по умолчанию 43200 (12 часов), диапазон ≥ 0.

Пример `.env`:
```
TOKEN=YOUR_VK_API_TOKEN
DEFAULT_WAIT_TIME=43200
```

## Форматы

### Новый формат `files/groups.txt`
```
groupid:[tags:b1:b2:b3:b4:b5:links:image]|delay
```
Где:
- `tags`, `b1..b5`, `links` — идентификаторы вариантов из соответствующих файлов (`##число` или `###имя`) либо `-` для случайного выбора.
- `image` — целочисленный ID фото (используется как `photo{bot_id}_{image}`).
- `delay` — длительность вида `1d2h3m4s` (части опциональны).

Примеры:
```
156716828:[-:1:-:###tajikistan:-:-:-:457239113]|3d2h
51153697:[-:-:-:2:-:-:-:457239111]|12h
```

Комментарии:
- Строки, начинающиеся с `# ` (решётка и пробел), игнорируются.

### Старый формат `files/groups.txt`
```
groupid:path|image[?seconds]
```
- Если `path == '-'`, то будет выбран случайный из `files/text1.txt`…`text5.txt`.
- Необязательный параметр `?seconds` задаёт задержку в секундах.

### Формат блочных файлов (TextBuilder)
Файлы: `files/tags.txt`, `files/block1.txt` … `files/block5.txt`, `files/links.txt`.

Разметка:
- Заголовки вариантов: `##<числовой_id>` или `###<имя>` на отдельной строке.
- Текст до следующего заголовка — содержимое варианта.

Пример:
```
##1
Привет из блока 1

###intro
Вступление для блока 1
```

## Запуск

1) Установить зависимости:
```
pip install -r requirements.txt
```

2) Создать `.env` с переменной `TOKEN`.

3) Наполнить `files/groups.txt` записями в новом или старом формате.

4) Запустить:
```
python botautomatic.py
```

## Логирование

- Информационные сообщения: `log.txt`
- Ошибки: `error_log.txt`

Семантика:
- В местах интеграции с VK API и принятия решений о публикации присутствуют расширенные логи о причинах, таймингах и ошибках.

## Разработка и тестирование

Стиль кодирования и документации:
- Docstring-и в стиле Google, аннотации типов повсеместно.
- Синхронизация docstring-ов с аннотациями типов.

Тесты:
- Будут добавлены в `tests/` (pytest).
  - Юнит-тесты для `parse`, `parse_duration`, `build_text`, `prepare`.
  - Моки VK API для `get_last_post` и `check_suggests`.

Линтеры:
- pydocstyle — проверка docstring-ов (Google style).
- mypy — строгая проверка типов основных модулей.
- pytest — запуск юнит-тестов и doctest-ов.

Автодокументация:
- MkDocs с документацией (разделы: Введение, Архитектура, Конфигурация, Форматы, API, Отладка).

## Ограничения и допущения

- Доступ к изображениям: ожидается, что `photo{bot_id}_{image}` опубликована/загружена ботом и доступна для прикрепления.
- Схема wall:
  - Тип стены 1: анализируем свои посты по `from_id == bot_id`.
  - Типы 2/3: анализируем по `signer_id == bot_id` и предложку (`filter="suggests"`).
- В случае некорректных форматов задержки или блоков — логирование и использование дефолтов/рандома.
- `dumping.pkl` — простой pickle-кэш по времени последней публикации; целостность не проверяется.

## Changelog и версии

- История изменений — см. `CHANGELOG.md`. Семантическое версионирование (semver).
