# API модулей

Документация публичных функций и их поведение. Стиль docstring — Google.

## botautomatic.py

Основной модуль приложения. Содержит логику парсинга конфигураций, сборки текстов, принятия решений о публикации и сам постинг через VK API.

### Константы и глобальные параметры

- `wait_time: int` — дефолтная задержка (секунды), берётся из `DEFAULT_WAIT_TIME` или 43200.
- `vk` — клиент VK API (получен из `vk_api.VkApi`).
- `bot_id: int` — идентификатор текущего пользователя (бота).
- `time_dict: dict[int, datetime]` — кэш времени публикации по группам.

### post(_target_group: int, _text: str, _image: int) -> None

Опубликовать пост в сообщество.

Аргументы:
- `_target_group` — ID группы (без знака).
- `_text` — текст поста.
- `_image` — числовой ID изображения (используется в attachments как `photo{bot_id}_{_image}`).

Исключения:
- `vk_api.ApiError` — ошибка VK API.

Замечания:
- Перед публикацией внешне производится решение (см. `check_suggests` и логику для стен типа 1).

### parse_duration(spec: str) -> int

Преобразует строку длительности (например, `1d2h3m4s`, `2h`, `45m`) в секунды.

Аргументы:
- `spec` — строка спецификации задержки.

Возвращает:
- Количество секунд.

Поведение:
- При некорректном формате — возвращает `wait_time` и пишет предупреждение в `error_log.txt`.

### load_variants_file(path: str) -> list[tuple[str, str]]

Загрузить варианты из файла (TAGS/BLOCK1..BLOCK5/LINKS) в формате `##число`/`###имя`.

Аргументы:
- `path` — путь к файлу.

Возвращает:
- Список `(идентификатор, текст_варианта)`.

### pick_variant(variants: list[tuple[str, str]], desired: str | None) -> str

Выбрать текст варианта по идентификатору или случайно, если `desired` равен `None` или `-`.

Аргументы:
- `variants` — список пар `(идентификатор, текст)`.
- `desired` — идентификатор варианта или `-`/`None` для случайного выбора.

Возвращает:
- Текст варианта или пустую строку, если список пуст.

### build_text(tags_var, b1_var, b2_var, b3_var, b4_var, b5_var, links_var) -> str

Собирает итоговый текст из источников `files/tags.txt`, `files/block1.txt`…`files/block5.txt`, `files/links.txt`.

Аргументы:
- `tags_var`, `b1_var`, `b2_var`, `b3_var`, `b4_var`, `b5_var`, `links_var` — идентификаторы вариантов или `-`/`None` для случайного выбора.

Возвращает:
- Собранный текст поста.

### parse(_string: str) -> tuple[int, str, int, int | None]

Распарсить строку `files/groups.txt`.

Поддерживаемые форматы:
- Новый: `groupid:[tags:b1:b2:b3:b4:b5:links:image]|delay`
- Старый: `groupid:path|image[?seconds]`

Возвращает:
- `(group_id, текст_или_путь, image_id, задержка_сек|None)`

Поведение:
- Новый формат возвращает уже собранный текст (через `build_text`).
- Старый формат возвращает путь (или `-`), который затем будет обработан `prepare`.

### prepare(_text_or_built: str) -> tuple[str, dict | None]

Подготовить текст к публикации и загрузить кэш времени.

Аргументы:
- `_text_or_built` — путь к файлу/`-` (старый формат) либо уже собранный текст (новый).

Возвращает:
- `(текст_поста, словарь_времени)`.

Поведение:
- Безопасно читает `files/dumping.pkl`, создаёт файл при отсутствии.
- При ошибке чтения текстового файла логирует проблему и возвращает пустую строку.

### get_last_post(_tg: int) -> dict | None | int

Получить последний пост бота на стене сообщества `_tg`.

Возвращает:
- Объект поста VK, `None` если не найден, либо `-1` при ошибке запроса.

Поведение:
- Для стен типа 1 ищется `from_id == bot_id`.
- Для стен типов 2/3 — `signer_id == bot_id`.

### check_suggests(_tg: int, time_s: int) -> int

Решить, нужно ли постить в стенах 2/3 с учётом предложки.

Аргументы:
- `_tg` — ID группы.
- `time_s` — порог времени (секунды).

Возвращает:
- `1` — постить.
- `0` — не постить.
- `-1` — ошибка при получении данных.

Поведение:
- Если предложка пуста и порог времени превышен (по `time_dict` или по последнему посту), возвращается `1`.
- Если предложка есть, но слишком старая, возвращается `1`.
- Иначе `0`.

### choose_time(_timer: int | None) -> int

Выбрать интервал публикации: `_timer` или дефолтный `wait_time`.

Аргументы:
- `_timer` — задержка (секунды) либо `None`.

Возвращает:
- Количество секунд.

---

## modules/module_logger.py

Лёгкий модуль логирования.

### Глобальные объекты

- `log: TextIO` — файловый дескриптор для информационного лога (`log.txt`).
- `elog: TextIO` — файловый дескриптор для лога ошибок (`error_log.txt`).

### Log(action: Any) -> None

Записать информационное сообщение в `log.txt`.

Аргументы:
- `action` — объект сообщения, приводится к строке.

### eLog(error: Any) -> None

Записать ошибку/предупреждение в `error_log.txt`.

Аргументы:
- `error` — объект ошибки/сообщения, приводится к строке.

---

## Контракты и гарантии

- Модули избегают бросать исключения при некритических ошибках I/O (логируют и продолжают).
- Ошибки VK API могут всплывать в вызывающий код (в местах публикации или получения данных).
- Отформатированные строки задержек должны удовлетворять регулярному выражению парсера; иначе применяется дефолт и пишется в `error_log`.
