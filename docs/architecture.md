# Архитектура

## Обзор

TBPostBot — утилита для автоматизированного постинга в сообщества VK. Основные подсистемы:

- botautomatic.py — основной цикл приложения:
  - Парсинг строк конфигурации `files/groups.txt` (новый и старый форматы).
  - Сборка текстов постов через TextBuilder из блочных файлов.
  - Интеграция с VK API, принятие решений о публикации с учётом типа стены и предложки.
  - Управление интервалами публикаций (включая кастомные задержки).
  - Логирование в файлы.
- modules/module_logger.py — минималистичный логгер:
  - Логи действий в `log.txt`.
  - Логи ошибок и предупреждений в `error_log.txt`.

## Поток данных

1) Чтение `files/groups.txt` построчно.
   - Пропуск комментариев: строки, начинающиеся с `# `, игнорируются.
2) Парсинг строки:
   - Новый формат — сборка текста из блоков TextBuilder.
   - Старый формат — загрузка текста из файла или случайного файла.
3) Определение интервала ожидания:
   - Новый формат: `|delay` (например, `3d2h`, `45m`).
   - Старый формат: `?seconds`.
   - Иначе — дефолт из `DEFAULT_WAIT_TIME`.
4) Получение параметров стены сообщества через VK API:
   - Тип стены 1 — публикации сразу на стену.
   - Типы 2/3 — публикации через предложку (suggests).
5) Принятие решения о публикации:
   - Стены 2/3: учитывается наличие/давность предложки и время с прошлого поста.
   - Стена 1: учитывается давность последней публикации бота.
6) Публикация и обновление кэша времени в `files/dumping.pkl`.

## TextBuilder

Сборка контента из блочных файлов:
- Источники: `files/tags.txt`, `files/block1.txt`…`files/block5.txt`, `files/links.txt`.
- Каждый файл содержит варианты, размеченные заголовками:
  - `##<числовой_id>` либо `###<имя>`.
  - Текст после заголовка до следующего заголовка — содержимое варианта.
- Выбор варианта:
  - Явно по идентификатору (например, `1`, `intro`, `###tajikistan`).
  - `-` — выбор случайного варианта.
- Объединение блоков: итоговый текст формируется конкатенацией непустых блоков с пустой строкой между ними.

## Форматы конфигурации

Новый формат:
```
groupid:[tags:b1:b2:b3:b4:b5:links:image]|delay
```
- `tags`, `b1..b5`, `links` — `-` (рандом) или id варианта из соответствующего файла.
- `image` — ID фото (используется `photo{bot_id}_{image}`).
- `delay` — длительность `1d2h3m4s` (части опциональны).

Старый формат:
```
groupid:path|image[?seconds]
```
- `path == '-'` — случайный выбор из `files/text1.txt`…`text5.txt`.
- `?seconds` — задержка в секундах (опционально).

Комментарии:
- Строки с префиксом `# ` — игнорируются.

## Логирование

- Информационные события (`Log`) — `log.txt`.
- Ошибки/предупреждения (`eLog`) — `error_log.txt`.
- Логируются ключевые действия: старт цикла, тип стены, решения о публикациях, ошибки VK API и чтения данных.

## Ошибки и надёжность

- Отсутствует `TOKEN` — аварийное завершение с пояснением.
- Ошибки VK API — логируются, решение о публикации может быть отложено.
- Неверный формат задержки — логируется, применяется дефолт `DEFAULT_WAIT_TIME`.
- `files/dumping.pkl` читается безопасно, файл создаётся при отсутствии.

## Ограничения

- Требуется валидный `TOKEN` с правами на публикацию в целевых сообществах.
- Фото `photo{bot_id}_{image}` должно быть доступно для прикрепления.
- Схема выбора постов основана на `from_id` (wall 1) и `signer_id` (wall 2/3), что требует корректного поведения VK API.
