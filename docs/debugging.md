# Отладка и логирование

Этот раздел описывает подход к диагностике проблем, работу с логами и типичные сценарии отладки TBPostBot.

## Логи

Проект пишет логи в два файла в корне:
- `log.txt` — информационные события (старт/окончание итерации, решения о публикации, диагностика таймингов и т.д.)
- `error_log.txt` — ошибки, предупреждения, некорректные форматы, проблемы I/O и VK API

Семантика сообщений:
- `Log(...)` — обычный ход работы (например: «Got the wall type», «Decision: post now» и пр.)
- `eLog(...)` — аномалии, ошибки и важные предупреждения (например: «Bad delay format ...», «get_last_post(...) failed: ...»)

Рекомендации:
- При запуске держите открытыми оба файла. Так сразу видно причину сбоев конфигурации и запросов.

## Типовые проблемы и их причины

1) Нет постинга в группу
- Причины:
  - Не пройден порог времени (`choose_time`) — в `log.txt` будет «Found a post ... evaluating time threshold» и далее «Threshold passed — posting» либо отсутствие этого сообщения.
  - Для стен 2/3 предложка не пустая/свежая — `check_suggests` вернёт `0`. В `log.txt` будет соответствующее сообщение.
  - `TOKEN` некорректен или не имеет прав — будут ошибки VK API в `error_log.txt`.
- Действия:
  - Убедитесь, что формат строки в `groups.txt` валиден и ожидаемая задержка действительно достигнута.
  - Проверьте права токена и доступность фото.

2) Ошибка формата задержки
- Причина:
  - `delay` в новом формате не соответствует `1d2h3m4s`.
- Действия:
  - Поправьте строку; при неверном формате применяется дефолтная задержка и пишется `eLog("Bad delay format ...")`.

3) Ошибка чтения текстового файла
- Причина:
  - Старый формат указывает на несуществующий файл, либо нет прав на чтение.
- Действия:
  - Проверьте `path` и права; в ошибке будет указан путь.

4) Пустые блоки в TextBuilder
- Причина:
  - В файле блоков отсутствуют варианты или некорректная разметка `##/###`.
- Действия:
  - Проверьте `files/tags.txt`, `files/block*.txt`, `files/links.txt`. Должны быть заголовки вида `##1`, `###name` и содержимое между заголовками.

5) Неверные id изображений
- Причина:
  - Указан `image`, которого нет в `photo{bot_id}_{image}`.
- Действия:
  - Проверьте, что бот может прикрепить данное фото (загружено ботом/доступно).

## Полезные приёмы отладки

1) Включение минимального wall‑интервала
- В `.env` уменьшите `DEFAULT_WAIT_TIME` (например, `60`) для ускорения итераций.
- В `groups.txt` используйте короткие задержки: `|10s`, `|1m`.

2) Синтетические блоки
- В `files/tags.txt`/`block*.txt` создайте упрощённые варианты (например, «TEST») и укажите их явно в `groups.txt`, чтобы исключить случайность.

3) Трассировка принятия решения
- Следите за последовательностью логов:
  - «Got the wall type»
  - «Should I post in group ... ? result=...»
  - «Decision: post now ...» или отсутствие публикации при `0`
  - Для стен 1: «Found a post, evaluating time threshold» и «Threshold passed — posting»

4) Отладка VK API без сети (в тестах)
- В тестах используется мокация `ba.vk` — см. `tests/test_vk_integration.py`.
- Для ручной проверки можно временно подменить `vk` на объект-заменитель со схожими методами.

## Проверка качества

- Юнит‑тесты:
  ```
  pytest
  ```
- Типы:
  ```
  mypy .
  ```
- Docstring (Google style):
  ```
  pydocstyle .
  ```

## FAQ

Q: Как комментировать строки в groups.txt?
- Любая строка, начинающаяся с `# ` (решётка и пробел), игнорируется парсером цикла.

Q: Что делать, если `dumping.pkl` повреждён?
- Скрипт пытается безопасно читать, но при ошибке запишет предупреждение и продолжит с пустым словарём. Можно удалять файл — он создастся заново.

Q: Можно ли смешивать новый и старый форматы?
- Да. Файл `groups.txt` может содержать строки обоих форматов — парсер определит их автоматически.
